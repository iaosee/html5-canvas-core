import{G as c}from"./lil-gui.esm-hsJpI9MV.js";import{B as h}from"./BaseDemo-CScLeyCm.js";const d="/html5-canvas-core/assets/video-01-D2V4S6Tn.mp4";class o extends h{constructor(e){super(e),this.name="视频 —— 视频渲染绘制",this.video=null,this.config={color:!0,flip:!1,play:()=>this.playVideo(),pause:()=>this.pauseVideo(),camera:()=>this.camera()},this.createVedio().createControl().initOffScreenCanvas().listenEvents()}static init(e){return new o(e)}start(){return this}draw(){return this}destroy(){super.destroy(),this.pauseVideo()}initOffScreenCanvas(){const{canvas:e}=this;return this.offScreenCanvas=document.createElement("canvas"),this.offScreenContext=this.offScreenCanvas.getContext("2d"),this.offScreenCanvas.width=e.width,this.offScreenCanvas.height=e.height,this}createControl(){const{config:e}=this;this.gui=new c;const{gui:t}=this;return t.add(e,"color"),t.add(e,"flip"),t.add(e,"play"),t.add(e,"pause"),t.add(e,"camera"),this}createVedio(){return this.video=document.createElement("video"),this.video.src=d,this}async camera(){var r;const{context:e}=this;this.pauseVideo(),this.clearScreen();const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),i=new ImageCapture((r=t.getVideoTracks())==null?void 0:r[0]),a=async()=>{if(!this.video.paused)return;const s=await i.grabFrame();e.drawImage(s,0,0),requestAnimationFrame(a)};return requestAnimationFrame(a),this}playVideo(){const{canvas:e,context:t,config:i}=this;if(!this.video.paused)return this;const a=()=>{this.offScreenContext.drawImage(this.video,0,0),!this.video.paused&&(i.color||this.removeColor(),i.flip?this.drawFlipped():t.drawImage(this.offScreenCanvas,0,0),requestAnimationFrame(a))};return this.video.play(),requestAnimationFrame(a),this}pauseVideo(){return this.video.pause(),this}removeColor(){const{offScreenCanvas:e,offScreenContext:t}=this,i=t.getImageData(0,0,e.width,e.height),a=i.data,r=a.length;for(let s=0;s<r-4;s+=4){const n=(a[s]+a[s+1]+a[s+2])/3;a[s]=n,a[s+1]=n,a[s+2]=n}t.putImageData(i,0,0)}drawFlipped(){const{canvas:e,context:t,offScreenCanvas:i}=this;t.save(),t.translate(this.width/2,this.height/2),t.rotate(Math.PI),t.translate(-this.width/2,-this.height/2),t.drawImage(i,0,0),t.restore()}listenEvents(){const{canvas:e}=this;return e.addEventListener("click",t=>{console.log(t)}),this}}export{o as Demo};
