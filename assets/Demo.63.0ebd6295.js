import{R as d}from"./index.87763aee.js";import{B as l}from"./BaseDemo.deaf79c0.js";class g{constructor(e,t){this.sprites=[],this.keyListeners=[],this.HIGH_SCORES_SUFFIX="_highscores",this.images=new Map,this.imageUrls=[],this.imagesIndex=0,this.imagesLoaded=0,this.imagesFailedToLoad=0,this.startTime=0,this.lastTime=0,this.gameTime=0,this.fps=0,this.STARTING_FPS=60,this.paused=!1,this.startedPauseAt=0,this.PAUSE_TIMEOUT=100,this.soundOn=!0,this.soundChannels=[],this.audio=new Audio,this.NUM_SOUND_CHANNELS=10,this.gameName=e,this.context=t.getContext("2d");for(let s=0;s<this.NUM_SOUND_CHANNELS;++s){const i=new Audio;this.soundChannels.push(i)}window.onkeypress=s=>{this.keyPressed(s)},window.onkeydown=s=>{this.keyPressed(s)}}keyPressed(e){let t;switch(e.keyCode){case 32:t="space";break;case 68:t="d";break;case 75:t="k";break;case 83:t="s";break;case 80:t="p";break;case 37:t="left arrow";break;case 39:t="right arrow";break;case 38:t="up arrow";break;case 40:t="down arrow";break}const s=this.findKeyListener(t);s&&s(e)}addKeyListener(e){this.keyListeners.push(e)}findKeyListener(e){let t;for(let s=0;s<this.keyListeners.length;++s){const i=this.keyListeners[s];i.key===e&&(t=i.listener)}return t}getImage(e){return this.images.get(e)}imageLoadedCallback(e){this.imagesLoaded++}imageLoadErrorCallback(e){this.imagesFailedToLoad++}loadImage(e){const t=new Image;t.src=e,t.addEventListener("load",s=>{this.imageLoadedCallback(s)}),t.addEventListener("error",s=>{this.imageLoadErrorCallback(s)}),this.images.set(e,t)}loadImages(){return this.imagesIndex<this.imageUrls.length&&(this.loadImage(this.imageUrls[this.imagesIndex]),this.imagesIndex++),(this.imagesLoaded+this.imagesFailedToLoad)/this.imageUrls.length*100}queueImage(e){this.imageUrls.push(e)}start(){this.startTime=Date.now(),requestAnimationFrame(e=>{this.animate(e)})}animate(e){if(this.paused){setTimeout(()=>{requestAnimationFrame(t=>{this.animate(t)})},this.PAUSE_TIMEOUT);return}this.tick(e),this.clearScreen(),this.startAnimate(e),this.paintUnderSprites(),this.updateSprites(e),this.paintSprites(e),this.paintOverSprites(),this.endAnimate(),this.lastTime=e,requestAnimationFrame(t=>{this.animate(t)})}tick(e){this.updateFrameRate(e),this.gameTime=Date.now()-this.startTime}updateFrameRate(e){this.lastTime===0?this.fps=this.STARTING_FPS:this.fps=1e3/(e-this.lastTime)}clearScreen(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)}updateSprites(e){for(let t=0;t<this.sprites.length;++t)this.sprites[t].update(this.context,e)}paintSprites(e){for(let t=0;t<this.sprites.length;++t){const s=this.sprites[t];s.visible&&s.paint(this.context)}}startAnimate(e){}endAnimate(){}paintOverSprites(){}paintUnderSprites(){}togglePaused(){const e=Date.now();this.paused=!this.paused,this.paused?this.startedPauseAt=e:(this.startTime=this.startTime+e-this.startedPauseAt,this.lastTime=e)}pixelsPerFrame(e,t){return t/this.fps}getHighScores(){const e=this.gameName+this.HIGH_SCORES_SUFFIX;return localStorage[e]==null&&(localStorage[e]=JSON.stringify([])),JSON.parse(localStorage[e])}setHighScore(e){const t=this.gameName+this.HIGH_SCORES_SUFFIX,s=localStorage[t]||"[]",i=JSON.parse(s);i.unshift(e),localStorage[t]=JSON.stringify(i)}clearHighScores(){localStorage[this.gameName+this.HIGH_SCORES_SUFFIX]=JSON.stringify([])}canPlayOggVorbis(){return this.audio.canPlayType('audio/ogg; codecs="vorbis"')!=""}canPlayMp3(){return this.audio.canPlayType("audio/mpeg")!=""}getAvailableSoundChannel(){let e;for(let t=0;t<this.NUM_SOUND_CHANNELS;++t)if(e=this.soundChannels[t],e.played.length===0||e.ended)return e}playSound(e){const t=this.getAvailableSoundChannel(),s=document.getElementById(e);t&&s&&(t.src=s.src===""?s.currentSrc:s.src,t.load(),t.play())}addSprite(e){this.sprites.push(e)}getSprite(e){for(const t in this.sprites)if(this.sprites[t].name===e)return this.sprites[t];return null}}class u{constructor(e){this.w=0,this.h=0,this.left=0,this.top=0,this.right=0,this.bottom=0,this.percentComplete=0,this.cornerRadius=0;const{w:t,h:s,strokeStyle:i,red:r,green:a,blue:h}=e;this.domElement=document.createElement("div"),this.context=document.createElement("canvas").getContext("2d"),this.domElement.appendChild(this.context.canvas),this.context.canvas.width=t+s,this.context.canvas.height=s,this.setProgressbarProperties(t,s),this.background.globalAlpha=.3,this.drawToBuffer(this.background,i,r,a,h),this.drawToBuffer(this.foreground,i,r,a,h),this.percentComplete=0}setProgressbarProperties(e,t){this.w=e,this.h=t,this.cornerRadius=this.h/2,this.right=this.left+this.cornerRadius+this.w+this.cornerRadius,this.bottom=this.top+this.h,this.background=document.createElement("canvas").getContext("2d"),this.foreground=document.createElement("canvas").getContext("2d"),this.background.canvas.width=e+t,this.background.canvas.height=t,this.foreground.canvas.width=e+t,this.foreground.canvas.height=t}draw(e){this.erase(),this.context.drawImage(this.background.canvas,0,0),e>0&&this.context.drawImage(this.foreground.canvas,0,0,this.foreground.canvas.width*(e/100),this.foreground.canvas.height,0,0,this.foreground.canvas.width*(e/100),this.foreground.canvas.height)}drawToBuffer(e,t,s,i,r){e.save(),e.fillStyle="rgb("+s+", "+i+", "+r+")",e.strokeStyle=t,e.beginPath(),e.moveTo(this.left+this.cornerRadius,this.top),e.lineTo(this.right-this.cornerRadius,this.top),e.arc(this.right-this.cornerRadius,this.top+this.cornerRadius,this.cornerRadius,-Math.PI/2,Math.PI/2),e.lineTo(this.left+this.cornerRadius,this.top+this.cornerRadius*2),e.arc(this.left+this.cornerRadius,this.top+this.cornerRadius,this.cornerRadius,Math.PI/2,-Math.PI/2),e.fill(),e.shadowColor=void 0;const a=e.createLinearGradient(this.left,this.top,this.left,this.bottom);a.addColorStop(0,"rgba(255,255,255,0.4)"),a.addColorStop(.3,"rgba(255,255,255,0.7)"),a.addColorStop(.4,"rgba(255,255,255,0.5)"),a.addColorStop(1,"rgba(255,255,255,0.1)"),e.fillStyle=a,e.fill(),e.lineWidth=.4,e.stroke(),e.restore()}erase(){this.context.clearRect(this.left,this.TOP,this.context.canvas.width,this.context.canvas.height)}}const c=110,m=450,p=80;class o extends l{constructor(e){super(e),this.canvas=e,this.name="\u7B80\u5355\u6E38\u620F\u5F15\u64CE",this.translateDelta=.025,this.translateOffset=0,this.gameOver=!1,this.livesLeft=3,this.game=new g("ungame",this.canvas),this.progressbar=new u({w:300,h:10,strokeStyle:"rgba(0,255,0,0.5)",red:100,green:130,blue:250}),this.progressbar.domElement.style.position="absolute",this.progressbar.domElement.style.top="20px",this.progressbar.domElement.style.left="20px",document.body.appendChild(this.progressbar.domElement),this.progressbar.draw(d.init(0,100).getOne()),this.configGame(),this.game.start()}static init(e){return new o(e)}start(){return this.draw()}destroy(){var e;return this.game.endAnimate(),(e=this.progressbar.domElement)==null||e.parentElement.removeChild(this.progressbar.domElement),this}draw(){return this.clearScreen().drawGrid().drawScene()}drawScene(){return this}configGame(){const{game:e}=this;e.paintOverSprites=()=>{this.paintNearCloud(e.context,120,20),this.paintNearCloud(e.context,e.context.canvas.width+120,20)},e.paintUnderSprites=()=>{!this.gameOver&&this.livesLeft===0||(this.paintSun(e.context),this.paintFarCloud(e.context,20,20),this.paintFarCloud(e.context,e.context.canvas.width+20,20),this.gameOver)},e.addKeyListener({key:"p",listener:()=>{e.togglePaused()}})}scrollBackground(){const{game:e}=this;this.translateOffset=(this.translateOffset+this.translateDelta)%e.context.canvas.width,e.context.translate(-this.translateOffset,0)}paintSun(e){e.save(),e.strokeStyle="orange",e.fillStyle="yellow",e.strokeStyle="orange",e.lineWidth=1,e.beginPath(),e.arc(m,c,p,0,Math.PI*2,!0),e.fill(),e.stroke(),e.stroke(),e.restore()}paintFarCloud(e,t,s){e.save(),this.scrollBackground(),e.lineWidth=.5,e.strokeStyle="rgba(100, 140, 230, 0, 0.8)",e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.moveTo(t+102,s+91),e.quadraticCurveTo(t+180,s+110,t+250,s+90),e.quadraticCurveTo(t+312,s+87,t+279,s+60),e.quadraticCurveTo(t+321,s+20,t+265,s+20),e.quadraticCurveTo(t+219,s+4,t+171,s+23),e.quadraticCurveTo(t+137,s+5,t+104,s+18),e.quadraticCurveTo(t+57,s+23,t+79,s+48),e.quadraticCurveTo(t+57,s+74,t+104,s+92),e.closePath(),e.stroke(),e.fill(),e.restore()}paintNearCloud(e,t,s){e.save(),this.scrollBackground(),this.scrollBackground(),e.lineWidth=.5,e.strokeStyle="rgba(100, 140, 230, 0, 0.8)",e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.fillStyle="rgba(255,255,255,0.7)",e.moveTo(t+364,s+37),e.quadraticCurveTo(t+426,s+28,t+418,s+72),e.quadraticCurveTo(t+450,s+123,t+388,s+114),e.quadraticCurveTo(t+357,s+144,t+303,s+115),e.quadraticCurveTo(t+251,s+118,t+278,s+83),e.quadraticCurveTo(t+254,s+46,t+320,s+46),e.quadraticCurveTo(t+326,s+12,t+362,s+37),e.closePath(),e.stroke(),e.fill(),e.restore()}}export{o as Demo};
