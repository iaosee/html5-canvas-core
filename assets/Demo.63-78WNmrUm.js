var l=Object.defineProperty;var g=(o,t,e)=>t in o?l(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var i=(o,t,e)=>g(o,typeof t!="symbol"?t+"":t,e);import{R as u}from"./index-D3O5bMvL.js";import{B as c}from"./BaseDemo-DB1y7toB.js";class m{constructor(t,e){i(this,"gameName");i(this,"context");i(this,"sprites",[]);i(this,"keyListeners",[]);i(this,"HIGH_SCORES_SUFFIX","_highscores");i(this,"images",new Map);i(this,"imageUrls",[]);i(this,"imagesIndex",0);i(this,"imagesLoaded",0);i(this,"imagesFailedToLoad",0);i(this,"imageLoadingProgressCallback");i(this,"startTime",0);i(this,"lastTime",0);i(this,"gameTime",0);i(this,"fps",0);i(this,"STARTING_FPS",60);i(this,"paused",!1);i(this,"startedPauseAt",0);i(this,"PAUSE_TIMEOUT",100);i(this,"soundOn",!0);i(this,"soundChannels",[]);i(this,"audio",new Audio);i(this,"NUM_SOUND_CHANNELS",10);this.gameName=t,this.context=e.getContext("2d");for(let s=0;s<this.NUM_SOUND_CHANNELS;++s){const a=new Audio;this.soundChannels.push(a)}window.onkeypress=s=>{this.keyPressed(s)},window.onkeydown=s=>{this.keyPressed(s)}}keyPressed(t){let e;switch(t.keyCode){case 32:e="space";break;case 68:e="d";break;case 75:e="k";break;case 83:e="s";break;case 80:e="p";break;case 37:e="left arrow";break;case 39:e="right arrow";break;case 38:e="up arrow";break;case 40:e="down arrow";break}const s=this.findKeyListener(e);s&&s(t)}addKeyListener(t){this.keyListeners.push(t)}findKeyListener(t){let e;for(let s=0;s<this.keyListeners.length;++s){const a=this.keyListeners[s];a.key===t&&(e=a.listener)}return e}getImage(t){return this.images.get(t)}imageLoadedCallback(t){this.imagesLoaded++}imageLoadErrorCallback(t){this.imagesFailedToLoad++}loadImage(t){const e=new Image;e.src=t,e.addEventListener("load",s=>{this.imageLoadedCallback(s)}),e.addEventListener("error",s=>{this.imageLoadErrorCallback(s)}),this.images.set(t,e)}loadImages(){return this.imagesIndex<this.imageUrls.length&&(this.loadImage(this.imageUrls[this.imagesIndex]),this.imagesIndex++),(this.imagesLoaded+this.imagesFailedToLoad)/this.imageUrls.length*100}queueImage(t){this.imageUrls.push(t)}start(){this.startTime=Date.now(),requestAnimationFrame(t=>{this.animate(t)})}animate(t){if(this.paused){setTimeout(()=>{requestAnimationFrame(e=>{this.animate(e)})},this.PAUSE_TIMEOUT);return}this.tick(t),this.clearScreen(),this.startAnimate(t),this.paintUnderSprites(),this.updateSprites(t),this.paintSprites(t),this.paintOverSprites(),this.endAnimate(),this.lastTime=t,requestAnimationFrame(e=>{this.animate(e)})}tick(t){this.updateFrameRate(t),this.gameTime=Date.now()-this.startTime}updateFrameRate(t){this.lastTime===0?this.fps=this.STARTING_FPS:this.fps=1e3/(t-this.lastTime)}clearScreen(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)}updateSprites(t){for(let e=0;e<this.sprites.length;++e)this.sprites[e].update(this.context,t)}paintSprites(t){for(let e=0;e<this.sprites.length;++e){const s=this.sprites[e];s.visible&&s.paint(this.context)}}startAnimate(t){}endAnimate(){}paintOverSprites(){}paintUnderSprites(){}togglePaused(){const t=Date.now();this.paused=!this.paused,this.paused?this.startedPauseAt=t:(this.startTime=this.startTime+t-this.startedPauseAt,this.lastTime=t)}pixelsPerFrame(t,e){return e/this.fps}getHighScores(){const t=this.gameName+this.HIGH_SCORES_SUFFIX;return localStorage[t]==null&&(localStorage[t]=JSON.stringify([])),JSON.parse(localStorage[t])}setHighScore(t){const e=this.gameName+this.HIGH_SCORES_SUFFIX,s=localStorage[e]||"[]",a=JSON.parse(s);a.unshift(t),localStorage[e]=JSON.stringify(a)}clearHighScores(){localStorage[this.gameName+this.HIGH_SCORES_SUFFIX]=JSON.stringify([])}canPlayOggVorbis(){return this.audio.canPlayType('audio/ogg; codecs="vorbis"')!=""}canPlayMp3(){return this.audio.canPlayType("audio/mpeg")!=""}getAvailableSoundChannel(){let t;for(let e=0;e<this.NUM_SOUND_CHANNELS;++e)if(t=this.soundChannels[e],t.played.length===0||t.ended)return t}playSound(t){const e=this.getAvailableSoundChannel(),s=document.getElementById(t);e&&s&&(e.src=s.src===""?s.currentSrc:s.src,e.load(),e.play())}addSprite(t){this.sprites.push(t)}getSprite(t){for(const e in this.sprites)if(this.sprites[e].name===t)return this.sprites[e];return null}}class p{constructor(t){i(this,"domElement");i(this,"context");i(this,"background");i(this,"foreground");i(this,"w",0);i(this,"h",0);i(this,"left",0);i(this,"top",0);i(this,"right",0);i(this,"bottom",0);i(this,"percentComplete",0);i(this,"cornerRadius",0);const{w:e,h:s,strokeStyle:a,red:h,green:r,blue:n}=t;this.domElement=document.createElement("div"),this.context=document.createElement("canvas").getContext("2d"),this.domElement.appendChild(this.context.canvas),this.context.canvas.width=e+s,this.context.canvas.height=s,this.setProgressbarProperties(e,s),this.background.globalAlpha=.3,this.drawToBuffer(this.background,a,h,r,n),this.drawToBuffer(this.foreground,a,h,r,n),this.percentComplete=0}setProgressbarProperties(t,e){this.w=t,this.h=e,this.cornerRadius=this.h/2,this.right=this.left+this.cornerRadius+this.w+this.cornerRadius,this.bottom=this.top+this.h,this.background=document.createElement("canvas").getContext("2d"),this.foreground=document.createElement("canvas").getContext("2d"),this.background.canvas.width=t+e,this.background.canvas.height=e,this.foreground.canvas.width=t+e,this.foreground.canvas.height=e}draw(t){this.erase(),this.context.drawImage(this.background.canvas,0,0),t>0&&this.context.drawImage(this.foreground.canvas,0,0,this.foreground.canvas.width*(t/100),this.foreground.canvas.height,0,0,this.foreground.canvas.width*(t/100),this.foreground.canvas.height)}drawToBuffer(t,e,s,a,h){t.save(),t.fillStyle="rgb("+s+", "+a+", "+h+")",t.strokeStyle=e,t.beginPath(),t.moveTo(this.left+this.cornerRadius,this.top),t.lineTo(this.right-this.cornerRadius,this.top),t.arc(this.right-this.cornerRadius,this.top+this.cornerRadius,this.cornerRadius,-Math.PI/2,Math.PI/2),t.lineTo(this.left+this.cornerRadius,this.top+this.cornerRadius*2),t.arc(this.left+this.cornerRadius,this.top+this.cornerRadius,this.cornerRadius,Math.PI/2,-Math.PI/2),t.fill(),t.shadowColor=void 0;const r=t.createLinearGradient(this.left,this.top,this.left,this.bottom);r.addColorStop(0,"rgba(255,255,255,0.4)"),r.addColorStop(.3,"rgba(255,255,255,0.7)"),r.addColorStop(.4,"rgba(255,255,255,0.5)"),r.addColorStop(1,"rgba(255,255,255,0.1)"),t.fillStyle=r,t.fill(),t.lineWidth=.4,t.stroke(),t.restore()}erase(){this.context.clearRect(this.left,this.TOP,this.context.canvas.width,this.context.canvas.height)}}const S=110,f=450,v=80;class d extends c{constructor(e){super(e);i(this,"name","简单游戏引擎");i(this,"game");i(this,"progressbar");i(this,"translateDelta",.025);i(this,"translateOffset",0);i(this,"gameOver",!1);i(this,"livesLeft",3);this.canvas=e,this.game=new m("ungame",this.canvas),this.progressbar=new p({w:300,h:10,strokeStyle:"rgba(0,255,0,0.5)",red:100,green:130,blue:250}),this.progressbar.domElement.style.position="absolute",this.progressbar.domElement.style.top="20px",this.progressbar.domElement.style.left="20px",document.body.appendChild(this.progressbar.domElement),this.progressbar.draw(u.init(0,100).getOne()),this.configGame(),this.game.start()}static init(e){return new d(e)}start(){return this.draw()}destroy(){var e;return this.game.endAnimate(),(e=this.progressbar.domElement)==null||e.parentElement.removeChild(this.progressbar.domElement),this}draw(){return this.clearScreen().drawGrid().drawScene()}drawScene(){return this}configGame(){const{game:e}=this;e.paintOverSprites=()=>{this.paintNearCloud(e.context,120,20),this.paintNearCloud(e.context,e.context.canvas.width+120,20)},e.paintUnderSprites=()=>{!this.gameOver&&this.livesLeft===0||(this.paintSun(e.context),this.paintFarCloud(e.context,20,20),this.paintFarCloud(e.context,e.context.canvas.width+20,20),this.gameOver)},e.addKeyListener({key:"p",listener:()=>{e.togglePaused()}})}scrollBackground(){const{game:e}=this;this.translateOffset=(this.translateOffset+this.translateDelta)%e.context.canvas.width,e.context.translate(-this.translateOffset,0)}paintSun(e){e.save(),e.strokeStyle="orange",e.fillStyle="yellow",e.strokeStyle="orange",e.lineWidth=1,e.beginPath(),e.arc(f,S,v,0,Math.PI*2,!0),e.fill(),e.stroke(),e.stroke(),e.restore()}paintFarCloud(e,s,a){e.save(),this.scrollBackground(),e.lineWidth=.5,e.strokeStyle="rgba(100, 140, 230, 0, 0.8)",e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.moveTo(s+102,a+91),e.quadraticCurveTo(s+180,a+110,s+250,a+90),e.quadraticCurveTo(s+312,a+87,s+279,a+60),e.quadraticCurveTo(s+321,a+20,s+265,a+20),e.quadraticCurveTo(s+219,a+4,s+171,a+23),e.quadraticCurveTo(s+137,a+5,s+104,a+18),e.quadraticCurveTo(s+57,a+23,s+79,a+48),e.quadraticCurveTo(s+57,a+74,s+104,a+92),e.closePath(),e.stroke(),e.fill(),e.restore()}paintNearCloud(e,s,a){e.save(),this.scrollBackground(),this.scrollBackground(),e.lineWidth=.5,e.strokeStyle="rgba(100, 140, 230, 0, 0.8)",e.fillStyle="rgba(255,255,255,0.4)",e.beginPath(),e.fillStyle="rgba(255,255,255,0.7)",e.moveTo(s+364,a+37),e.quadraticCurveTo(s+426,a+28,s+418,a+72),e.quadraticCurveTo(s+450,a+123,s+388,a+114),e.quadraticCurveTo(s+357,a+144,s+303,a+115),e.quadraticCurveTo(s+251,a+118,s+278,a+83),e.quadraticCurveTo(s+254,a+46,s+320,a+46),e.quadraticCurveTo(s+326,a+12,s+362,a+37),e.closePath(),e.stroke(),e.fill(),e.restore()}}export{d as Demo};
