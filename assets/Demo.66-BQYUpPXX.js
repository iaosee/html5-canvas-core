import{B as ie}from"./BaseDemo-CScLeyCm.js";import{S as $}from"./Sprite-DYUj_957.js";var b={},te,oe;function se(e,r,t,n){var a=0,n=n===void 0?{}:n,o=n.loop===void 0?null:n.loop,s=n.palette===void 0?null:n.palette;if(r<=0||t<=0||r>65535||t>65535)throw new Error("Width/Height invalid.");function d(i){var c=i.length;if(c<2||c>256||c&c-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return c}e[a++]=71,e[a++]=73,e[a++]=70,e[a++]=56,e[a++]=57,e[a++]=97;var v=0,l=0;if(s!==null){for(var w=d(s);w>>=1;)++v;if(w=1<<v,--v,n.background!==void 0){if(l=n.background,l>=w)throw new Error("Background index out of range.");if(l===0)throw new Error("Background index explicitly passed as 0.")}}if(e[a++]=r&255,e[a++]=r>>8&255,e[a++]=t&255,e[a++]=t>>8&255,e[a++]=(s!==null?128:0)|v,e[a++]=l,e[a++]=0,s!==null)for(var _=0,I=s.length;_<I;++_){var y=s[_];e[a++]=y>>16&255,e[a++]=y>>8&255,e[a++]=y&255}if(o!==null){if(o<0||o>65535)throw new Error("Loop count invalid.");e[a++]=33,e[a++]=255,e[a++]=11,e[a++]=78,e[a++]=69,e[a++]=84,e[a++]=83,e[a++]=67,e[a++]=65,e[a++]=80,e[a++]=69,e[a++]=50,e[a++]=46,e[a++]=48,e[a++]=3,e[a++]=1,e[a++]=o&255,e[a++]=o>>8&255,e[a++]=0}var m=!1;this.addFrame=function(i,c,k,x,u,g){if(m===!0&&(--a,m=!1),g=g===void 0?{}:g,i<0||c<0||i>65535||c>65535)throw new Error("x/y invalid.");if(k<=0||x<=0||k>65535||x>65535)throw new Error("Width/Height invalid.");if(u.length<k*x)throw new Error("Not enough pixels for the frame size.");var B=!0,G=g.palette;if(G==null&&(B=!1,G=s),G==null)throw new Error("Must supply either a local or global palette.");for(var X=d(G),F=0;X>>=1;)++F;X=1<<F;var M=g.delay===void 0?0:g.delay,W=g.disposal===void 0?0:g.disposal;if(W<0||W>3)throw new Error("Disposal out of range.");var q=!1,D=0;if(g.transparent!==void 0&&g.transparent!==null&&(q=!0,D=g.transparent,D<0||D>=X))throw new Error("Transparent color index.");if((W!==0||q||M!==0)&&(e[a++]=33,e[a++]=249,e[a++]=4,e[a++]=W<<2|(q===!0?1:0),e[a++]=M&255,e[a++]=M>>8&255,e[a++]=D,e[a++]=0),e[a++]=44,e[a++]=i&255,e[a++]=i>>8&255,e[a++]=c&255,e[a++]=c>>8&255,e[a++]=k&255,e[a++]=k>>8&255,e[a++]=x&255,e[a++]=x>>8&255,e[a++]=B===!0?128|F-1:0,B===!0)for(var N=0,A=G.length;N<A;++N){var E=G[N];e[a++]=E>>16&255,e[a++]=E>>8&255,e[a++]=E&255}return a=le(e,a,F<2?2:F,u),a},this.end=function(){return m===!1&&(e[a++]=59,m=!0),a},this.getOutputBuffer=function(){return e},this.setOutputBuffer=function(i){e=i},this.getOutputBufferPosition=function(){return a},this.setOutputBufferPosition=function(i){a=i}}function le(e,r,t,f){e[r++]=t;var a=r++,n=1<<t,o=n-1,s=n+1,d=s+1,v=t+1,l=0,w=0;function _(g){for(;l>=g;)e[r++]=w&255,w>>=8,l-=8,r===a+256&&(e[a]=255,a=r++)}function I(g){w|=g<<l,l+=v,_(8)}var y=f[0]&o,m={};I(n);for(var i=1,c=f.length;i<c;++i){var k=f[i]&o,x=y<<8|k,u=m[x];if(u===void 0){for(w|=y<<l,l+=v;l>=8;)e[r++]=w&255,w>>=8,l-=8,r===a+256&&(e[a]=255,a=r++);d===4096?(I(n),d=s+1,v=t+1,m={}):(d>=1<<v&&++v,m[x]=d++),y=k}else y=u}return I(y),I(s),_(1),a+1===r?e[a]=0:(e[a]=r-a-1,e[r++]=0),r}function de(e){var r=0;if(e[r++]!==71||e[r++]!==73||e[r++]!==70||e[r++]!==56||(e[r++]+1&253)!==56||e[r++]!==97)throw new Error("Invalid GIF 87a/89a header.");var t=e[r++]|e[r++]<<8,f=e[r++]|e[r++]<<8,a=e[r++],n=a>>7,o=a&7,s=1<<o+1;e[r++],e[r++];var d=null,v=null;n&&(d=r,v=s,r+=s*3);var l=!0,w=[],_=0,I=null,y=0,m=null;for(this.width=t,this.height=f;l&&r<e.length;)switch(e[r++]){case 33:switch(e[r++]){case 255:if(e[r]!==11||e[r+1]==78&&e[r+2]==69&&e[r+3]==84&&e[r+4]==83&&e[r+5]==67&&e[r+6]==65&&e[r+7]==80&&e[r+8]==69&&e[r+9]==50&&e[r+10]==46&&e[r+11]==48&&e[r+12]==3&&e[r+13]==1&&e[r+16]==0)r+=14,m=e[r++]|e[r++]<<8,r++;else for(r+=12;;){var i=e[r++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;r+=i}break;case 249:if(e[r++]!==4||e[r+4]!==0)throw new Error("Invalid graphics extension block.");var c=e[r++];_=e[r++]|e[r++]<<8,I=e[r++],c&1||(I=null),y=c>>2&7,r++;break;case 254:for(;;){var i=e[r++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;r+=i}break;default:throw new Error("Unknown graphic control label: 0x"+e[r-1].toString(16))}break;case 44:var k=e[r++]|e[r++]<<8,x=e[r++]|e[r++]<<8,u=e[r++]|e[r++]<<8,g=e[r++]|e[r++]<<8,B=e[r++],G=B>>7,X=B>>6&1,F=B&7,M=1<<F+1,W=d,q=v,D=!1;if(G){var D=!0;W=r,q=M,r+=M*3}var N=r;for(r++;;){var i=e[r++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;r+=i}w.push({x:k,y:x,width:u,height:g,has_local_palette:D,palette_offset:W,palette_size:q,data_offset:N,data_length:r-N,transparent_index:I,interlaced:!!X,delay:_,disposal:y});break;case 59:l=!1;break;default:throw new Error("Unknown gif block: 0x"+e[r-1].toString(16))}this.numFrames=function(){return w.length},this.loopCount=function(){return m},this.frameInfo=function(A){if(A<0||A>=w.length)throw new Error("Frame index out of range.");return w[A]},this.decodeAndBlitFrameBGRA=function(A,E){var h=this.frameInfo(A),Z=h.width*h.height,z=new Uint8Array(Z);ee(e,h.data_offset,z,Z);var C=h.palette_offset,O=h.transparent_index;O===null&&(O=256);var S=h.width,L=t-S,P=S,Y=(h.y*t+h.x)*4,j=((h.y+h.height)*t+h.x)*4,p=Y,U=L*4;h.interlaced===!0&&(U+=t*4*7);for(var H=8,T=0,J=z.length;T<J;++T){var R=z[T];if(P===0&&(p+=U,P=S,p>=j&&(U=L*4+t*4*(H-1),p=Y+(S+L)*(H<<1),H>>=1)),R===O)p+=4;else{var K=e[C+R*3],Q=e[C+R*3+1],V=e[C+R*3+2];E[p++]=V,E[p++]=Q,E[p++]=K,E[p++]=255}--P}},this.decodeAndBlitFrameRGBA=function(A,E){var h=this.frameInfo(A),Z=h.width*h.height,z=new Uint8Array(Z);ee(e,h.data_offset,z,Z);var C=h.palette_offset,O=h.transparent_index;O===null&&(O=256);var S=h.width,L=t-S,P=S,Y=(h.y*t+h.x)*4,j=((h.y+h.height)*t+h.x)*4,p=Y,U=L*4;h.interlaced===!0&&(U+=t*4*7);for(var H=8,T=0,J=z.length;T<J;++T){var R=z[T];if(P===0&&(p+=U,P=S,p>=j&&(U=L*4+t*4*(H-1),p=Y+(S+L)*(H<<1),H>>=1)),R===O)p+=4;else{var K=e[C+R*3],Q=e[C+R*3+1],V=e[C+R*3+2];E[p++]=K,E[p++]=Q,E[p++]=V,E[p++]=255}--P}}}function ee(e,r,t,f){for(var a=e[r++],n=1<<a,o=n+1,s=o+1,d=a+1,v=(1<<d)-1,l=0,w=0,_=0,I=e[r++],y=new Int32Array(4096),m=null;;){for(;l<16&&I!==0;)w|=e[r++]<<l,l+=8,I===1?I=e[r++]:--I;if(l<d)break;var i=w&v;if(w>>=d,l-=d,i===n){s=o+1,d=a+1,v=(1<<d)-1,m=null;continue}else if(i===o)break;for(var c=i<s?i:m,k=0,x=c;x>n;)x=y[x]>>8,++k;var u=x,g=_+k+(c!==i?1:0);if(g>f){console.log("Warning, gif stream longer than expected.");return}t[_++]=u,_+=k;var B=_;for(c!==i&&(t[_++]=u),x=c;k--;)x=y[x],t[--B]=x&255,x>>=8;m!==null&&s<4096&&(y[s++]=m<<8|u,s>=v+1&&d<12&&(++d,v=v<<1|1)),m=i}return _!==f&&console.log("Warning, gif stream shorter than expected."),t}try{oe=b.GifWriter=se,te=b.GifReader=de}catch{}class re{constructor(r){this.lastTime=Date.now(),this.image=new Image,this.frameIndex=0,this.frames=[],this.image.src=r,this.loadImage(r).then(t=>this.decodeFrame(t))}loadImage(r){return new Promise((f,a)=>{const n=new XMLHttpRequest;n.open("GET",r,!0),n.responseType="arraybuffer",n.onreadystatechange=o=>{n.readyState===XMLHttpRequest.DONE&&(n.status===200?f(n.response):a())},n.send()})}decodeFrame(r){const t=new te(new Uint8Array(r)),f=[];for(var a=0,n=t.numFrames();a<n;a++){const o=t.frameInfo(a),s=new Uint8ClampedArray(t.width*t.height*4);t.decodeAndBlitFrameRGBA(a,s);const d=document.createElement("canvas"),v=d.getContext("2d"),l=v.createImageData(o.width,o.height);d.width=o.width,d.height=o.height,l.data.set(s),v.putImageData(l,-o.x,-o.y),f.push({frame:o,pixels:s,buffer:l,bufferCanvas:d})}this.frames=f}advance(){this.frameIndex===this.frames.length-1?this.frameIndex=0:this.frameIndex++}async paint(r,t){if(!this.frames||!this.frames.length)return;const f=r.x||r.left,a=r.y||r.top,n=this.frames[this.frameIndex],o=r.width||this.image.width,s=r.height||this.image.height;this.image.complete?t.drawImage(n.bufferCanvas,f,a,o,s):this.image.onload=d=>{r.width=this.image.width,r.height=this.image.height,t.drawImage(this.image,f,a,r.width,r.height)}}}class ae{constructor(){this.lastAdvance=0}execute(r,t,f){const a=r.painter.frames[r.painter.frameIndex];if(!a)return;const n=f-this.lastAdvance,o=a.frame.delay*10;n>=o&&(r.painter.advance(),this.lastAdvance=f)}}const he="/html5-canvas-core/assets/yoda-Dya9GSFi.gif",ve="/html5-canvas-core/assets/run-rabbit-BnYRboye.gif";class ne extends ie{constructor(r){super(r),this.name="Gif 动画 — Gif 解析与绘制",this.config={},this.createSprite()}static init(r){return new ne(r)}draw(r=0){return this.drawScene(r),this}createSprite(){const r=new $("yoda",new re(he));r.addBehavior(new ae),r.x=100,r.y=100;const t=new $("runRabbit",new re(ve));t.addBehavior(new ae),t.x=900,t.y=200,this.sprite1=r,this.sprite2=t}drawScene(r=0){const{context:t,config:f}=this;return this.clearScreen().drawGrid(),this.sprite1.update(t,r),this.sprite1.paint(t),this.sprite2.update(t,r),this.sprite2.paint(t),this}}export{ne as Demo};
