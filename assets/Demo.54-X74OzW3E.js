var f=Object.defineProperty;var k=(r,i,t)=>i in r?f(r,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[i]=t;var o=(r,i,t)=>k(r,typeof i!="symbol"?i+"":i,t);import{G as S}from"./lil-gui.esm-hsJpI9MV.js";import{B as x}from"./BaseDemo-DB1y7toB.js";import{r as p}from"./util-CX8edQ7O.js";import{S as u}from"./Sprite-9nB6cOPC.js";const I="/html5-canvas-core/assets/bucket-BlnG4nFw.png",T=10,v=Math.PI/4;class m extends x{constructor(t){super(t);o(this,"name","抛射物体");o(this,"ball");o(this,"ledge");o(this,"bucket");o(this,"bucketImage");o(this,"score",0);o(this,"lastScore",0);o(this,"lastMouse",{x:0,y:0});o(this,"launchAngle",v);o(this,"launchVelocity",0);o(this,"pixelsPerMeter",this.width/T);o(this,"ballInFlight",!1);o(this,"threePointer",!1);o(this,"tipsInfo",document.createElement("div"));o(this,"lastBallPosition",{x:0,y:0});o(this,"config",{ledge:{X:100,Y:this.height-100,WIDTH:100},ball:{RADIUS:10},bucket:{X:this.width-200,Y:this.height-150},drawRay:!1,GRAVITY_FORCE:9.81,launchTime:void 0});this.canvas=t,this.createControl().addTipsToScene().loadImage(I).then(e=>{this.bucketImage=e,this.initSprite().resetSpriteStatus().listenEvents().startPlay()})}static init(t){return new m(t)}createControl(){const{config:t}=this;this.gui=new S;const{gui:e}=this;return e.add(t.ledge,"X").min(50).max(this.width).step(10).onFinishChange(()=>this.resetSpriteStatus()),e.add(t.ledge,"Y").min(50).max(this.height).step(10).onFinishChange(()=>this.resetSpriteStatus()),e.add(t.ledge,"WIDTH").min(50).max(300).step(10).onFinishChange(()=>this.resetSpriteStatus()),e.add(t.ball,"RADIUS").min(10).max(50).step(5).onFinishChange(()=>this.resetSpriteStatus()),e.add(t.bucket,"X").min(500).max(this.width-100).step(5).onFinishChange(()=>this.resetSpriteStatus()),e.add(t.bucket,"Y").min(10).max(this.height-100).step(5).onFinishChange(()=>this.resetSpriteStatus()),e.add(t,"drawRay").onFinishChange(a=>{t.drawRay=!!a}),this}start(){return this}draw(t){return this.clearScreen().drawGrid().drawScene(t)}destroy(){super.destroy(),this.tipsInfo.remove()}addTipsToScene(){return p(this.tipsInfo,{position:"absolute",zIndex:"5",cursor:"crosshair",top:"0",left:"50%",transform:"translate(-50%, 0)"}),document.body.appendChild(this.tipsInfo),this}initSprite(){const{config:t,bucketImage:e}=this;this.ledge=new u("ledge",{paint(h,s){s.save(),s.shadowColor="rgba(0,0,0,0.5)",s.shadowBlur=8,s.shadowOffsetX=2,s.shadowOffsetY=2,s.fillStyle="rgba(255,255,0,0.6)",s.strokeStyle="rgba(0,0,0,0.6)",s.beginPath(),s.rect(h.x,h.y,h.width,h.height),s.fill(),s.stroke(),s.restore()}}),this.ball=new u("ball",{paint(h,s){s.save(),s.beginPath(),s.arc(h.x,h.y,t.ball.RADIUS,0,Math.PI*2,!1),s.clip(),s.shadowColor="rgba(0,0,255,0.7)",s.shadowOffsetX=-4,s.shadowOffsetY=-4,s.shadowBlur=8,s.lineWidth=2,s.strokeStyle="rgba(100,100,195,0.8)",s.stroke(),s.beginPath(),s.arc(h.x,h.y,t.ball.RADIUS/2,0,Math.PI*2,!1),s.clip(),s.shadowColor="rgba(255,255,0,1.0)",s.shadowOffsetX=-4,s.shadowOffsetY=-4,s.shadowBlur=8,s.stroke(),s.restore()}},[]),this.bucket=new u("bucket",{paint(h,s){s.strokeStyle="rgba(100,100,195,0.8)",s.rect(h.x,h.y,h.width,h.height),s.stroke(),s.drawImage(e,h.x,h.y)}});const a=new P(this),l=new B(this);return this.ball.addBehavior(a),this.bucket.addBehavior(l),this}drawScene(t){const{context:e,ball:a,ledge:l,bucket:h,config:s}=this;return this.ballInFlight||(this.drawGuidewire(),this.updateBackgroundText(),this.lastScore!==0&&this.resetScoreLater()),l.update(e,t),a.update(e,t),h.update(e,t),l.paint(e),a.paint(e),h.paint(e),this.drawRayGuideline(),this}drawRayGuideline(){const{context:t,config:e,bucket:a}=this;return e.drawRay?(t.save(),t.beginPath(),t.lineWidth=.5,t.strokeStyle="red",t.moveTo(0,a.y+.5),t.lineTo(this.canvas.width,a.y),t.stroke(),t.restore(),this):this}resetScoreLater(){setTimeout(()=>{this.lastScore=0},1e3)}resetSpriteStatus(){const{config:t,bucketImage:e}=this;return this.ledge.x=t.ledge.X,this.ledge.y=t.ledge.Y,this.ledge.width=t.ledge.WIDTH,this.ledge.height=10,this.ball.width=t.ball.RADIUS*2,this.ball.height=t.ball.RADIUS*2,this.ball.x=this.ledge.x+this.ledge.width/2,this.ball.y=this.ledge.y-this.ball.height/2,this.ball.velocityX=0,this.ball.velocityY=0,this.bucket.x=t.bucket.X,this.bucket.y=t.bucket.Y,this.bucket.width=e.width,this.bucket.height=e.height,this.ballInFlight=!1,this}drawGuidewire(){const{context:t,lastMouse:e,ball:a,bucket:l}=this;return t.save(),t.strokeStyle="rgba(200,200,200,0.8)",t.beginPath(),t.setLineDash([4,4]),t.lineDashOffset=5,t.moveTo(a.x,a.y),t.lineTo(e.x,e.y),t.stroke(),t.restore(),this}showText(t){const{context:e,ball:a,bucket:l}=this,h=e.measureText(t);return e.font="42px Helvetica",e.save(),e.shadowColor=void 0,e.strokeStyle="rgb(80,120,210)",e.fillStyle="rgba(100,140,230,0.5)",e.fillText(t,this.width/2-h.width/2,this.height/2),e.strokeText(t,this.width/2-h.width/2,this.height/2),e.restore(),this}updateBackgroundText(){this.lastScore===3?this.showText("真厉害!"):this.lastScore===2&&this.showText("好球!")}listenEvents(){const{canvas:t,config:e,lastMouse:a,ball:l}=this;return t.addEventListener("mousemove",h=>{if(!this.ballInFlight){const s=this.coordinateTransformation(h.clientX,h.clientY);a.x=s.x,a.y=s.y;const n=a.x-l.x,c=Math.abs(a.y-l.y);this.launchAngle=Math.atan(c/n),this.launchVelocity=4*c/Math.sin(this.launchAngle)/this.pixelsPerMeter||0;const d="Angle: "+(this.launchAngle*180/Math.PI).toFixed(2)+" degrees, Velocity: "+this.launchVelocity.toFixed(2)+" m/s";this.tipsInfo.innerHTML=d}}),t.addEventListener("mousedown",h=>{this.ballInFlight||(l.velocityX=this.launchVelocity*Math.cos(this.launchAngle),l.velocityY=this.launchVelocity*Math.sin(this.launchAngle),this.ballInFlight=!0,this.threePointer=!1,e.launchTime=void 0)}),this}}class P{constructor(i){o(this,"lastFrameTime");o(this,"GRAVITY_FORCE",9.81);this.demo=i}applyGravity(i){const{demo:t}=this,{ball:e,config:a}=this.demo;e.velocityY=this.GRAVITY_FORCE*i-t.launchVelocity*Math.sin(t.launchAngle)}updateBallPosition(i){const{demo:t}=this,{ball:e}=this.demo;t.lastBallPosition.x=e.x,t.lastBallPosition.y=e.y,e.x+=e.velocityX*i*t.pixelsPerMeter,e.y+=e.velocityY*i*t.pixelsPerMeter}checkForThreePointer(){const{demo:i}=this,{ball:t}=this.demo;t.y<0&&(i.threePointer=!0,console.log("Three pointer if hit"))}checkBallBounds(){const{demo:i}=this,{ball:t}=this.demo;(t.y>i.height||t.x>i.width)&&i.resetSpriteStatus()}execute(i,t,e){const{demo:a}=this,{ball:l,config:h}=this.demo;let s=0,n=0;a.ballInFlight&&(h.launchTime===void 0&&(h.launchTime=e),s=(e-this.lastFrameTime)/1e3,n=(e-h.launchTime)/1e3,this.applyGravity(n),this.updateBallPosition(s),this.checkForThreePointer(),this.checkBallBounds()),this.lastFrameTime=e}}class B{constructor(i){o(this,"intersectionPoint",{x:0,y:0});this.demo=i}ballInBucket1(){const{ball:i,bucket:t}=this.demo;return i.x>t.x+t.width/2&&i.x<t.x+t.width&&i.y>t.y&&i.y<t.y+t.height}ballInBucket2(){const{ball:i,bucket:t,config:e}=this.demo,a={x:i.x+e.ball.RADIUS,y:i.y+e.ball.RADIUS},l={x:t.x+t.width/2,y:t.y+t.height/2};return Math.sqrt(Math.pow(l.x-a.x,2)+Math.pow(l.y-a.y,2))<e.ball.RADIUS+t.width/8}ballInBucket3(){const{config:i,ball:t,bucket:e,lastBallPosition:a}=this.demo;if(a.x===t.x||a.y===t.y)return!1;const l=a.x,h=a.y;t.x,t.y;const s=e.x+e.width/4,n=e.y,c=e.x+e.width,b=n,d=(t.y-a.y)/(t.x-a.x),g=(b-n)/(c-s),y=h-d*l,w=n-g*s;return this.intersectionPoint.x=(w-y)/(d-g),this.intersectionPoint.y=d*this.intersectionPoint.x+y,this.intersectionPoint.x>s&&this.intersectionPoint.x<c&&t.y+i.ball.RADIUS>n&&t.x+i.ball.RADIUS<c}ballInBucket(){const{config:i,ball:t,bucket:e,lastBallPosition:a}=this.demo,l=t.velocityY/t.velocityX,h=t.y-l*t.x,s=e.y,n=(s-h)/l;return this.intersectionPoint={x:n,y:s},n>e.x&&n<e.x+e.width&&t.x>e.x&&t.x<e.x+e.width&&t.y>e.y&&t.y<e.y+e.height}drawRay(){const{context:i,ball:t}=this.demo;i.beginPath(),i.save(),i.lineWidth=1,i.strokeStyle="blue",i.moveTo(t.x,t.y),i.lineTo(this.intersectionPoint.x,this.intersectionPoint.y),i.stroke(),i.restore()}adjustScore(){const{demo:i}=this;i.threePointer?i.lastScore=3:i.lastScore=2,i.score+=i.lastScore,console.log(this.demo.score)}execute(i,t,e){const{demo:a}=this;a.config.drawRay&&this.drawRay(),a.ballInFlight&&this.ballInBucket()&&(a.resetSpriteStatus(),this.adjustScore())}}export{B as CatchBallBehavior,m as Demo,P as LobBallBehavior};
